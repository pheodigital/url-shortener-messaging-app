name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:

  # ─── URL Service Tests ──────────────────────────────────
  test-url-service:
    name: url-service tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: services/url-service/package-lock.json

      - name: Install dependencies
        working-directory: services/url-service
        run: npm ci

      - name: Run tests
        working-directory: services/url-service
        run: npm test
        env:
          NODE_ENV: test
          PORT: "3002"
          BASE_URL: http://localhost:80
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379
          JWT_ACCESS_SECRET: test-secret-that-is-at-least-32-chars!!
          RABBITMQ_URL: amqp://localhost:5672
          RABBITMQ_QUEUE_CLICK_EVENTS: click_events

  # ─── Auth Service Tests ─────────────────────────────────
  test-auth-service:
    name: auth-service tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: services/auth-service/package-lock.json

      - name: Install dependencies
        working-directory: services/auth-service
        run: npm ci

      - name: Run tests
        working-directory: services/auth-service
        run: npm test
        env:
          NODE_ENV: test
          PORT: "3001"
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          JWT_ACCESS_SECRET: test-secret-that-is-at-least-32-chars!!
          JWT_ACCESS_EXPIRES_IN: 15m
          JWT_REFRESH_SECRET: test-refresh-secret-at-least-32-chars!!
          JWT_REFRESH_EXPIRES_IN: 7d
          GOOGLE_CLIENT_ID: test-google-client-id
          GOOGLE_CLIENT_SECRET: test-google-client-secret
          GOOGLE_CALLBACK_URL: http://localhost:3001/auth/google/callback
          ALLOWED_ORIGIN: http://localhost:3000

  # ─── Analytics Worker Tests ─────────────────────────────
  test-analytics-worker:
    name: analytics-worker tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: services/analytics-worker/package-lock.json

      - name: Install dependencies
        working-directory: services/analytics-worker
        run: npm ci

      - name: Run tests
        working-directory: services/analytics-worker
        run: npm test
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/test
          RABBITMQ_URL: amqp://localhost:5672
          RABBITMQ_QUEUE_CLICK_EVENTS: click_events

  # ─── Analytics Service Tests ────────────────────────────
  test-analytics-service:
    name: analytics-service tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: services/analytics-service/package-lock.json

      - name: Install dependencies
        working-directory: services/analytics-service
        run: npm ci

      - name: Run tests
        working-directory: services/analytics-service
        run: npm test
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/test
          JWT_ACCESS_SECRET: test-secret-that-is-at-least-32-chars!!
          ALLOWED_ORIGIN: http://localhost:3000
