name: Docker Build & Push

# ─── Triggers ─────────────────────────────────────────────
# Runs on push to main — builds and pushes to GHCR
# Images are used by cd.yml for deployments
on:
  push:
    branches:
      - main

# ─── Permissions ──────────────────────────────────────────
# Required to push to GitHub Container Registry (GHCR)
permissions:
  contents: read
  packages: write

jobs:

  # ─── Build & Push All Images ────────────────────────────
  # All 4 services build in parallel — faster pipeline
  # Images pushed to GHCR (ghcr.io) not Docker Hub
  build-and-push:
    name: Build and push ${{ matrix.service }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - url-service
          - auth-service
          - analytics-worker
          - analytics-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ── Login to GHCR ────────────────────────────────────
      # Uses GITHUB_TOKEN — no extra secrets needed
      # GITHUB_TOKEN is automatically provided by GitHub Actions
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ── Set up Docker Buildx ─────────────────────────────
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ── Extract metadata ─────────────────────────────────
      # Generates image tags and labels automatically
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}
          tags: |
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      # ── Build and push ───────────────────────────────────
      # Tags:
      #   latest         → most recent main build
      #   sha-<commit>   → immutable, used for rollbacks
      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ matrix.service }}
          dockerfile: ./services/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
