version: "3.9"

# ─── URL Shortener — docker-compose ──────────────────────
#
# External services (managed in the cloud):
#   PostgreSQL  → Neon
#   Redis       → Upstash or Redis Cloud
#   RabbitMQ    → CloudAMQP
#   MongoDB     → MongoDB Atlas
#
# Usage:
#   docker-compose up --build          start all services
#   docker-compose up --build -d       start in background
#   docker-compose down                stop all services
#   docker-compose logs -f             tail all logs
#   docker-compose logs -f url-service tail one service
#
# Routing (via NGINX on port 80):
#   /auth/*      → auth-service:3001
#   /api/urls*   → url-service:3002
#   /api/stats*  → analytics-service:3003
#   /health      → url-service:3002
#   /:shortcode  → url-service:3002

networks:
  app-network:
    driver: bridge

services:
  # ─── NGINX Gateway ────────────────────────────────────
  # Single entry point for all traffic on port 80
  # Routes to services based on path prefix
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      auth-service:
        condition: service_healthy
      url-service:
        condition: service_healthy
      analytics-service:
        condition: service_healthy

  # ─── Auth Service ─────────────────────────────────────
  # Handles Google OAuth2 + JWT issuance
  # Port 3001 not exposed — traffic comes through NGINX
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    env_file:
      - ./services/auth-service/.env
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ─── URL Service ──────────────────────────────────────
  # Core URL shortening + redirect service
  # Port 3002 not exposed — traffic comes through NGINX
  url-service:
    build:
      context: ./services/url-service
      dockerfile: Dockerfile
    container_name: url-service
    env_file:
      - ./services/url-service/.env
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      auth-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ─── Analytics Worker ─────────────────────────────────
  # Background worker — no HTTP server, no ports
  # Consumes click_events from RabbitMQ → stores in MongoDB
  analytics-worker:
    build:
      context: ./services/analytics-worker
      dockerfile: Dockerfile
    container_name: analytics-worker
    env_file:
      - ./services/analytics-worker/.env
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      url-service:
        condition: service_healthy

  # ─── Analytics Service ────────────────────────────────
  # HTTP API for click stats — reads from MongoDB
  # Port 3003 not exposed — traffic comes through NGINX
  analytics-service:
    build:
      context: ./services/analytics-service
      dockerfile: Dockerfile
    container_name: analytics-service
    env_file:
      - ./services/analytics-service/.env
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
